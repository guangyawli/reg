{% extends 'base.html' %}
{% load static %}
{% block title %}我的作品{% endblock  %}
{% block STYLEcontent %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf_viewer.min.css" />
    <style>
    .nav-link.active {
        background-color: white !important;
    }
    .nav-link.active span{
        background-color: #17a2b8 !important;
    }
    .nav-link:hover span{
        background-color: #17a2b8 !important;
    }
    </style>
{% endblock %}
{% block error_content %}

{% endblock %}
{% block content %}
    {% if files %}
      <section class="bottom" id="table-section">
        <div class="container">
            <h2 class="title">我的作品</h2>
            <p class="sub_title">檢視我的個人作品</p>
            <div class="content-box table-responsive">
                <button class="btn btn-outline-info mb-1" onclick="location.href='{% url 'add_files' %}'"  type="submit"><i class="far fa-edit"></i>
                   編輯
                </button>
                <div class="row">
                    <div class="col-12 col-md-3">
                        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                          <a class="nav-link active" id="v-pills-home-tab" data-toggle="pill" href="#v-pills-home" role="tab" aria-controls="v-pills-home" aria-selected="true">
                              <h5><span class="badge badge-secondary">作品說明書</span></h5>
                          </a>
                          <a class="nav-link" id="v-pills-profile-tab" data-toggle="pill" href="#v-pills-profile" role="tab" aria-controls="v-pills-profile" aria-selected="false">
                              <h5><span class="badge badge-secondary">作品影片</span></h5>
                          </a>
                          <a class="nav-link" id="v-pills-messages-tab" data-toggle="pill" href="#v-pills-messages" role="tab" aria-controls="v-pills-messages" aria-selected="false">
                              <h5><span class="badge badge-secondary">競賽切結書</span></h5>
                          </a>
                        </div>
                    </div>
                    <div class="col-12 col-md-9">
                        <div class="tab-content" id="v-pills-tabContent">
                          <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab">
                              <div class="page_title fw9" id="pdf-box">
                                <i id="previous_button" onclick="previousPage()" class="fas fa-arrow-alt-circle-left pni cursor-pointer"></i>
                                <span id="current_page"></span>/<span id="total_page"></span>
                                <i id="next_button" onclick="nextPage()" class="fas fa-arrow-alt-circle-right pni cursor-pointer"></i>
                                <canvas id="the-canvas"></canvas>
                              </div>
                          </div>
                          <div class="tab-pane fade" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">
                              {% if files.video_link %}
                                  <div class="youtube_container">
                                      <iframe src="{{ video_embed_link }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="video"></iframe>
                                  </div>
                              {% else %}
                                  <p class="sub_title">未上傳影片</p>
                              {% endif %}
                          </div>
                          <div class="tab-pane fade" id="v-pills-messages" role="tabpanel" aria-labelledby="v-pills-messages-tab">
                                <div class="page_title fw9" id="pdf-box2">
                                     <canvas id="the-canvas"></canvas>
                                </div>
                          </div>
                          <div class="tab-pane fade" id="v-pills-settings" role="tabpanel" aria-labelledby="v-pills-settings-tab">...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </section>
    {% else %}
        <section class="bottom" id="table-section">
        <div class="container">
            <h2 class="title">檔案上傳</h2>
            <p class="sub_title">新增檔案</p>
            <div class="content-box table-responsive">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                      <h3 class="title">隊伍資料</h3>
                      <div class="form-row">
                        <div class="col-12 mb-3 pb-20">
                          <label>
                              <h5><span class="badge badge-info">隊伍主題</span></h5>
                          </label>
                          {{ post_form.team_topic }}
                        </div>
                        <div class="col-12 mb-3 pb-20">
                          <label>
                              <h5><span class="badge badge-info">作品說明書</span></h5>
                          </label>
                            <br>
                          {{ post_form.readme }}
                        </div>
                        <div class="col-12 mb-3 pb-20">
                          <label>
                              <h5><span class="badge badge-info">切結書</span></h5>
                          </label>
                            <br>
                          {{ post_form.affidavit }}
                        </div>
                        <div class="col-12 mb-3 pb-20">
                          <label>
                              <h5><span class="badge badge-info">影片連結</span></h5>
                          </label>
                          {{ post_form.video_link }}
                        </div>
                      </div>
                      <hr>
                      <button type="submit" class="btn btn-outline-info mb-1">
                          <i class="far fa-check-circle pr-05"></i>送出
                      </button>
                </form>
            </div>
        </div>
    </section>
    {% endif %}
{% endblock  %}

{% block JScontent %}
    <script src="{% static "js/pdfjs/pdf.js" %}"></script>
    <script src="{% static "js/pdfjs/pdf.worker.js" %}"></script>
    <script>
    {#-------------開始時載入pdf-------------#}
    let current_page=1;
    let total_page='';
    {% if files.readme %}
        var url = "{{ files.readme.url }}";
        var url2 = "{{ files.affidavit.url }}";
    {% else %}
        var url = "";
    {% endif %}
    window.onload = function() {
        pdfBox('pdf-box',url,current_page);
        {#pdfBox('pdf-box2',url2,1);#}
    };


    {#-------------判斷螢幕縮放-------------#}
    var rtime;
    var timeout = false;
    var delta = 200;
    $(window).resize(function() {
        rtime = new Date();
        if (timeout === false) {
            timeout = true;
            setTimeout(resizeend, delta);
        }
    });

    function resizeend() {
        if (new Date() - rtime < delta) {
            setTimeout(resizeend, delta);
        } else {
            timeout = false;
            pdfBox('pdf-box',url,current_page);
        }
    }
    {#-------------pdf主程式-------------#}
    {#function pdfURL() {#}
    {#    window.open(url);#}
    {# } #}
    function previousPage() {
        if (current_page !== 1) {
            current_page -= 1;
            pdfBox('pdf-box',url,current_page);
        }
    }
    function nextPage() {
        if (current_page !== total_page) {
            current_page += 1;
            pdfBox('pdf-box',url,current_page);
        }
    }
    function pdfBox(id,url,page) {
        var loadingTask = pdfjsLib.getDocument(url);
        loadingTask.promise.then(function (pdf) {
            var pageNumber = page;
            $('#total_page').text(pdf.numPages);
            total_page = pdf.numPages;
            pdf.getPage(pageNumber).then(function (page) {
                // Prepare canvas using PDF page dimensions
                var container = document.getElementById(id);
                var canvas = document.getElementById('the-canvas');
                var context = canvas.getContext('2d');

                var viewport = page.getViewport(1);
                var scale = container.clientWidth / viewport.width;
                viewport = page.getViewport(scale);

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Render PDF page into canvas context
                var renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                var renderTask = page.render(renderContext);
                renderTask.promise.then(function () {
                });
            });
            if (pdf.numPages > 1) {
                if (current_page === 1) {
                    $('#previous_button').css({'color':'#4d4d4d','cursor':'default'});
                } else {
                    $('#previous_button').css({'color':'#FF6722','cursor':'pointer'});
                }

                if (current_page === pdf.numPages) {
                    $('#next_button').css({'color':'#4d4d4d','cursor':'default'});
                } else {
                    $('#next_button').css({'color':'#FF6722','cursor':'pointer'});
                }
            }
            $('#current_page').text(current_page)
            }, function (reason) {
                // PDF loading error
                console.log(reason);
            });
        }
    </script>
{% endblock %}

